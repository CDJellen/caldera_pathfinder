<link rel="stylesheet" href="/pathfinder/css/pathfinder.css" xmlns="http://www.w3.org/1999/html">
<script src="/pathfinder/js/pathfinder.js"></script>

<div x-data="alpinePathfinder()" x-init="initPage()">
    <div>
        <h2 x-text="name"></h2>
        <p x-text="description"></p>
    </div>
    <hr>
    <p>Pathfinder interactive attack path planning [demo]</p>
    <button class="button is-small is-primary" x-text="'Get hosts from selected report.'" @click="getHosts();"></button>
    <div>
        <table id="hosts" class="table is-striped is-fullwidth">
            <thead>
                <tr>
                    <th>Host Name</th>
                    <th>Modify Host</th>
                    <th>Possible Abilities</th>
                    <th>Freebie Abilities</th>
                </tr>
            </thead>
            <tbody>
                <template x-for="(host, index) of hostObjects" :key="index">
                    <tr>
                        <td x-text="host.name"><td>
                        <td>
                            <button class="button is-small is-primary" x-text="host.ip" @click="selectedHost=host; selectHost();"></button>
                        </td>
                        <td x-text="host.possible_abilities"></td>
                        <td x-text="host.freebie_abilities"></td>
                    </tr>
                </template>
            </tbody>
        </table>
    </div>
    <div>
        <select x-model="selectedSource">
            <template x-for="(host, index) of hostObjects" :key="index">
                <option x-text="host.ip"></option>
            </template>
        </select>
         
        Source: <span x-text="selectedSource"></span>
    </div>
    <div>
        <select x-model="selectedTarget">
            <template x-for="(host, index) of hostObjects" :key="index">
                <option x-text="host.ip"></option>
            </template>
        </select>
         
        Target: <span x-text="selectedTarget"></span>
    </div>
    <div>
        <button class="button is-small is-primary" x-text="'Test get paths'" @click="getPathsV2();"></button>
    </div>
    <br>
    <div>
        <button class="button is-small is-primary" x-text="'Test create adv: success'" @click="createAdversaryV2(path_success);"></button>
        <button class="button is-small is-primary" x-text="'Test create adv: stealth'" @click="createAdversaryV2(path_stealth);"></button>
        <button class="button is-small is-primary" x-text="'Test create adv: persistance'" @click="createAdversaryV2(path_persistance);"></button>
        <button class="button is-small is-primary" x-text="'Test create adv: speed'" @click="createAdversaryV2(path_speed);"></button>
    </div>
    <hr>
    <div id="pathfinder-section" class="section-profile">
        <div class="row">
            <div class="column section-border" style="flex:25%;text-align:left;">
                <div class="tab-bar">
                    <button class='selected' onclick="changeInputOptions(event, 'scanSection')">Scan</button>
                    <button onclick="changeInputOptions(event, 'importSection')">Import</button>
                    <button onclick="changeInputOptions(event, 'graphSection')">View</button>
                </div>
                <br>
                <div>
                    <div class="pathfinderSection" id="scanSection">
                        <label for="scannerSelection">Scanner:</label><br>
                        <select id="scannerSelection" onchange="setupScannerSection()">
                            <option value="" disabled selected>Select the scanner to use</option>
                                {% for s in scanners %}
                                    <option value="{{ s }}">{{ s }}</option>
                                {% endfor %}}
                        </select>
                        <div id="dynamicScannerSection">
                        </div>
                        <br>
                        <button id="startScan" type="button" class="button-notready atomic-button" style="margin-top:0;"
                                title="Start scan after configuring scanner" onclick="startScan()">Scan</button>
                        <button id="viewFacts" type="button" class="button-notready atomic-button" style="margin-top:0;"
                                title="View facts collected during a scan"
                                x-on:click="addTab('fact sources', '/advanced/sources')">View Facts</button>
                    </div>
                    <div class="pathfinderSection" id="importSection" style="display:none;">
                        <label for="scanInputFormat">Report Format:</label>
                        <select id="scanInputFormat" onchange="validateParser()">
                            <option value="" disabled selected>Select the report format</option>
                                {% for p in input_parsers %}
                                    <option value="{{ p }}">{{ p }}</option>
                                {% endfor %}}
                        </select>
                        <input id="fileInput" type="file" name="name" style="display: none;" />
                        <br><br>
                        <button id="startImport" type="button" class="button-notready atomic-button" style="margin-top:0;"
                                title="Import using selected parser" onclick="importScan()">Import</button>
                    </div>
                    <div class="pathfinderSection" id="graphSection" style="display:none;">
                        <label for="vulnerabilityReport">Vulnerability Report:</label>
                        <select id="vulnerabilityReport" onchange="validateFormState(true, '#showGraph');
                        validateFormState(true, '#downloadReport'); validateFormState(true, '#renameReport');
                        validateFormState(true, '#removeReport'); validateFormState(true, '#editGraph');">
                            <option value="" disabled selected>Select a report</option>
                            {% for r in vulnerability_reports %}
                                <option value="{{ r.id }}">{{ r.name }}</option>
                            {% endfor %}}
                        </select>
                        <div>
                            <div class='controls'>
                                <div class='setting'>
                                    <label for='link-distance'>Size: <span id='link-distance-value'></span></label>
                                    <br>
                                    <input type='range' min='1' max='100' default='50' id='link-distance'>
                                </div>
                            </div>
                            <div>
                                <label for="graphLegend">Legend:</label>
                                <ul id="graphLegend">
                                    <li><span class="legend_dot" style="background-color:gray"></span>&nbsp&nbsp scanner</li>
                                    <li><span class="legend_dot" style="background-color:deepskyblue"></span>&nbsp&nbsp network host</li>
                                    <li><span class="legend_dot" style="background-color:orangered"></span>&nbsp&nbsp CVE</li>
                                    <li><span class="legend_dot" style="background-color:blue"></span>&nbsp&nbsp open port</li>
                                </ul>
                            </div>
                        </div>
                        <br>
                        <button id="showGraph" type="button" class="button-notready atomic-button"
                                onclick="graphReport()" style="margin-top:0">Graph</button>
                        <br>
                        <button id="editGraph" type="button" class="button-notready atomic-button"
                                @click="updateEdges(); editReport()" style="margin-top:0">Edit Graph</button>
                        <br>
                        <div x-data="{ reportMenuOpen: false }" x-on:click.outside="reportMenuOpen = false">
                            <button x-on:click="reportMenuOpen = !reportMenuOpen">
                                Report Options
                            </button>
                            <div x-show="reportMenuOpen">
                                <p> Rename, download, and delete reports from Pathfinder.</p>
                                <label for="newReportName">New Report Name:</label>
                                <input id="newReportName" type="text" name="newReportName" value="" style="width:75%; margin:5px;">
                                <button id="renameReport" type="button" class="button-notready atomic-button"
                                        onclick="renameVulnerabilityReport()" style="margin-top:0">Rename Report</button>
                                <button id="downloadReport" type="button" class="button-notready atomic-button"
                                        onclick="downloadVulnerabilityReport()" style="margin-top:0">Download Report</button><br>
                                <button id="removeReport" type="button" class="button-notready atomic-button"
                                        onclick="removeVulnerabilityReport()" style="margin-top:0">Delete Report</button>
                                <button id="testHostInfo" type="button" class="button-ready atomic-button"
                                        onclick="testHostInfo()" style="margin-top:0">Test Host Info</button>

                            </div>
                        </div>
                        <div x-data="{ adversaryMenuOpen: false }" x-on:click.outside="adversaryMenuOpen = false">
                            <button x-on:click="adversaryMenuOpen = !adversaryMenuOpen">
                                Adversary Options
                            </button>
                            <div x-show="adversaryMenuOpen">
                                <p>Create a custom adversary using the source and target nodes specified in the attach graph.</p>
                                <p>Once created, this adversary will appear in the "adversaries" tab.</p>
                                <p>Existing Pathfinder adversaries can be merged by including their name in the "Adversary Merging Tags".</p>
                                <label for="adversaryTags">Adversary Merging Tags:</label>
                                <input id="adversaryTags" type="text" name="adversaryTags" value="" style="width:75%; margin:5px;">
                                <button id="createAdversary" type="button" class="button-notready atomic-button"
                                        x-on:click="createAdversary()" style="margin-top:0">Create Adversary</button>
                                <button id="viewAdversaries" type="button" class="button-notready atomic-button"
                                        x-on:click="addTab('adversaries', '/campaign/profiles')" style="margin-top:0">View Adversaries</button>
                                <button id="setupOperation" type="button" class="button-notready atomic-button"
                                        x-on:click="addTab('operations', '/campaign/operations')" style="margin-top:0">Setup Operation</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="column" style="flex:75%">
                <div id="logView">
                    <label for="logWindow">Output</label><br>
                    <textarea id="logWindow" class="column log-box" rows="4" style="height:90%"></textarea>
                </div>
                <div id="graphView" style="display:none;">
                </div>
            </div>
        </div>

    <div id="templateSection" style="display:none">
        <div id="textInputTemplate" style="display:none; margin:5px">
            <label for="textInput">text field:</label><br>
            <input id="textInput" type="text" name="txi1" value="" style="width:75%; margin:5px;">
        </div>
        <div id="pulldownInputTemplate" style="display:none; margin:5px">
            <label for="pulldownInput">pulldown:</label>
            <select id="pulldownInput">
            </select>
        </div>
        <div id="checkboxInputTemplate" style="display:none; margin:5px">
            <input type="checkbox" value="0" onchange="$(this).val(this.checked ? 1 : 0)"><span>checkbox title</span>
        </div>
    </div>

    <!-- MODALS -->

    <!-- EDIT HOST MODAL -->>
    <div class="modal" x-bind:class="{ 'is-active': showHostModal }">
        <div class="modal-background" @click="showHostModal = false"></div>
        <div class="modal-card wide">
            <header class="modal-card-head">
                <p class="modal-card-title"><span x-text="'Edit Existing'"></span> Host Object</p>
            </header>
            <section class="modal-card-body">
                <template x-if="selectedHost">
                    <div class="content">
                        <form>
                            <p class="has-text-left">Host Object Parameters</p>
                            <div class="field is-horizontal">
                                <div class="field-label">
                                    <label class="label">IP</label>
                                </div>
                                <div class="field-body">
                                    <div class="field has-addons">
                                        <div class="control is-expanded">
                                            <input class="input" x-model="selectedHost.ip" disabled>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="field is-horizontal">
                                <div class="field-label">
                                    <label class="label">Name</label>
                                </div>
                                <div class="field-body">
                                    <div class="field">
                                        <div class="control">
                                            <input class="input" x-model="selectedHost.name">
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="field is-horizontal">
                                <div class="field-label">
                                    <label class="label">OS Type</label>
                                </div>
                                <div class="field-body">
                                    <div class="field">
                                        <div class="control">
                                            <input class="input" x-model="selectedHost.os_type" disabled>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="field is-horizontal">
                                <div class="field-label">
                                    <label class="label">Access Established</label>
                                </div>
                                <div class="field-body">
                                    <div class="field">
                                        <div class="control">
                                            <input class="input" x-model="selectedHost.accessed" disabled>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="field is-horizontal">
                                <div class="field-label">
                                    <label class="label">Access Probability</label>
                                </div>
                                <div class="field-body">
                                    <div class="field">
                                        <div class="control">
                                            <input class="input" x-model="selectedHost.access_prob">
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </form>
                        <br>
                        <p class="has-text-left">Possible Abilities</p>
                            <template x-for="(uuid, index) of selectedHost.possible_abilities" :key="index">
                                <div class="field is-horizontal">
                                    <div class="field-body">
                                        <div class="field has-addons">
                                            <div class="control">
                                                <a class="control has-tooltip-bottom has-tooltip-arrow" data-tooltip="Success Probability">
                                                    <input class="input" size="3" x-model="selectedHost.possible_abilities_success_prob[index]"></input>
                                                </a>
                                            </div>
                                            <div class="control is-expanded">
                                                <input class="input" x-model="selectedHost.possible_abilities[index]"></input>
                                            </div>
                                            <div class="control">
                                                <a class="button has-tooltip-left has-tooltip-arrow" data-tooltip="Remove Possible Ability" @click="selectedHost.possible_abilities.splice(index, 1); selectedHost.possible_abilities_success_prob.splice(index, 1)">
                                                    <span class="icon"><i class="fas fa-minus-square"></i></span>
                                                </a>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </template>
                            <div class="field is-horizontal">
                                <div class="field-label" x-show="!selectedHost.possible_abilities.length">
                                    <label class="label">Possible Abilities</label>
                                </div>
                                <div class="field-body">
                                    <div class="field">
                                        <div class="control has-text-right">
                                            <button class="button is-small is-primary" @click.stop="selectedHost.possible_abilities.push(''); selectedHost.possible_abilities_success_prob.push(0)">+ Add Possible Ability</button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        <br>
                        <p class="has-text-left">Freebie Abilities</p>
                            <template x-for="(uuid, index) of selectedHost.freebie_abilities" :key="index">
                                <div class="field is-horizontal">
                                    <div class="field-body">
                                        <div class="field has-addons">
                                            <div class="control is-expanded">
                                                <input class="input" x-model="selectedHost.freebie_abilities[index]"></input>
                                            </div>
                                            <div class="control">
                                                <a class="button has-tooltip-left has-tooltip-arrow" data-tooltip="Remove Freebie Ability" @click="selectedHost.freebie_abilities.splice(index, 1);">
                                                    <span class="icon"><i class="fas fa-minus-square"></i></span>
                                                </a>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </template>
                            <div class="field is-horizontal">
                                <div class="field-label" x-show="!selectedHost.freebie_abilities.length">
                                    <label class="label">Freebie Abilities</label>
                                </div>
                                <div class="field-body">
                                    <div class="field">
                                        <div class="control has-text-right">
                                            <button class="button is-small is-primary" @click.stop="selectedHost.freebie_abilities.push('');">+ Add Freebie Ability</button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        <br>
                        <p class="has-text-left">Denied Abilities</p>
                            <template x-for="(uuid, index) of selectedHost.denied_abilities" :key="index">
                                <div class="field is-horizontal">
                                    <div class="field-body">
                                        <div class="field has-addons">
                                            <div class="control is-expanded">
                                                <input class="input" x-model="selectedHost.denied_abilities[index]"></input>
                                            </div>
                                            <div class="control">
                                                <a class="button has-tooltip-left has-tooltip-arrow" data-tooltip="Remove Denied Ability" @click="selectedHost.denied_abilities.splice(index, 1);">
                                                    <span class="icon"><i class="fas fa-minus-square"></i></span>
                                                </a>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </template>
                            <div class="field is-horizontal">
                                <div class="field-label" x-show="!selectedHost.denied_abilities.length">
                                    <label class="label">Denied Abilities</label>
                                </div>
                                <div class="field-body">
                                    <div class="field">
                                        <div class="control has-text-right">
                                            <button class="button is-small is-primary" @click.stop="selectedHost.denied_abilities.push('');">+ Add Denied Ability</button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        <br>
                    </div>
                </template>
            </section>
            <footer class="modal-card-foot">
                <nav class="level">
                    <div class="level-left">
                        <div class="level-item">
                            <button class="button is-primary is-small" @click="" x-show="!isCreating">
                                <span class="icon"><i class="fas fa-trash"></i></span>
                                <span>Delete Host</span>
                            </button>
                        </div>
                    </div>
                    <div class="level-right">
                        <div class="level-item">
                            <button class="button is-small" @click="showHostModal = false">Close</button>
                        </div>
                        <div class="level-item">
                            <button class="button is-primary is-small" @click="saveHost(selectedHost);">
                                <span class="icon"><i class="fas fa-save"></i></span>
                                <span>Save</span>
                            </button>
                        </div>
                    </div>
                </nav>
            </footer>
        </div>
    </div>

    <!-- EDIT REPORT MODAL -->>
    <div class="modal" x-bind:class="{ 'is-active': showReportModal }">
        <div class="modal-background" @click="showReportModal = false"></div>
        <div class="modal-card wide">
            <header class="modal-card-head">
                <p class="modal-card-title">Edit Report Edges</p>
            </header>
            <section class="modal-card-body">
                <template x-if="selectedReportEdges">
                    <div class="content">
                        <p class="has-text-left">Graph Edges</p>
                            <template x-for="(edge, index) of selectedReportEdges" :key="index">
                                <div class="field is-horizontal">
                                    <div class="field-body">
                                        <div class="field has-addons">
                                            <div class="control is-expanded">
                                                <input class="input" x-model="selectedReportEdges[index][0]"></input>
                                            </div>
                                            <div class="control is-expanded">
                                                <input class="input" x-model="selectedReportEdges[index][1]"></input>
                                            </div>
                                            <div class="control">
                                                <a class="button has-tooltip-left has-tooltip-arrow" data-tooltip="Remove Edge" @click="selectedReportEdges.splice(index, 1);">
                                                    <span class="icon"><i class="fas fa-minus-square"></i></span>
                                                </a>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </template>
                            <div class="field is-horizontal">
                                <div class="field-label" x-show="!selectedReportEdges.length">
                                    <label class="label">Graph Edges</label>
                                </div>
                                <div class="field-body">
                                    <div class="field">
                                        <div class="control has-text-right">
                                            <button class="button is-small is-primary" @click.stop="selectedReportEdges.push(['', '']);">+ Add New Edge</button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        <br>
                    </div>
                </template>
            </section>
            <footer class="modal-card-foot">
                <nav class="level">
                    <div class="level-right">
                        <div class="level-item">
                            <button class="button is-small" @click="showReportModal = false">Close</button>
                        </div>
                        <div class="level-item">
                            <button class="button is-primary is-small" @click="saveEdges(selectedReportEdges);">
                                <span class="icon"><i class="fas fa-save"></i></span>
                                <span>Save</span>
                            </button>
                        </div>
                    </div>
                </nav>
            </footer>
        </div>
    </div>
</div>

<script>

function alpinePathfinder() {
    return {
        name: '{{ name }}',
        description: '{{ description }}',
        scanners: '{{ scanners }}',
        input_parsers: '{{ input_parsers }}',
        vulnerability_reports: '{{ vulnerability_reports }}',
        hostObjects: [],
        selectedHost: {
            ip: '',
            name: '',
            possible_abilities: [],
            possible_abilities_success_prob: [],
            freebie_abilities: [],
            denied_abilities: [],
        },
        selectedSource: '',
        selectedTarget: '',
        selectedReport: '',
        selectedReportEdges: [],
        paths: [],
        path_success: [],
        path_stealth: [],
        path_persistance: [],
        path_speed: [],
        selected_path: [],

        showHostModal: false,
        showReportModal: false,
        isEditing: false,
        isCreating: false,

        initPage() {
            apiV2('GET', '/api/v2/health').then((response) => {
            }).catch((error) => {
                toast('Error loading page', false);
                console.error(error);
            });
        },

        getHosts() {
            current_report = $('#vulnerabilityReport').val();
            console.log(current_report);
            apiV2('POST', '/plugin/pathfinder/api', {'index':'host_info', 'id':current_report}).then((response) => {
                this.hostObjects = response.hosts;
                console.log(this.hostObjects);
                toast('Added Host Objects to Table', true);
            }).catch((error) => {
                toast('Error loading page', false);
                console.error(error);
            });
        },

        selectHost() {
            this.showHostModal = true;
            console.log(this.selectedHost);
        },
        
        updateEdges() {
            current_report = $('#vulnerabilityReport').val();
            apiV2('POST', '/plugin/pathfinder/api', {'index':'edge_info', 'report_id': current_report}).then((response) => {
                this.selectedReportEdges = response.edges;
                console.log(this.selectedReportEdges);
            }).catch((error) => {
                toast('Error loading graph edges', false);
                console.error(error);
            });
        },

        saveEdges(edgeData) {
            current_report = $('#vulnerabilityReport').val();
            apiV2('POST', '/plugin/pathfinder/api', {'index':'update_edges', 'report_id': current_report, 'edge_data': edgeData}).then((response) => {
                console.log(response.status);
            }).catch((error) => {
                toast('Error loading graph edges', false);
                console.error(error);
            });
            graphReport();
        },

        editReport() {
            this.showReportModal = true;
            console.log(this.selectedReport);
        },

        selectSource(host) {
            this.selectedSource = host.ip;
            console.log(this.selectedSource);
        },

        selectTarget(host) {
            this.selectedTarget = host.ip;
            console.log(this.selectedTarget);
        },

        getPaths() {
            current_report = $('#vulnerabilityReport').val();
            apiV2('POST', '/plugin/pathfinder/api', {'index':'paths', 'id': current_report, 'source': this.selectedSource, 'target': this.selectedTarget}).then((response) => {
                toast('Returned possible attack paths.', true);
                this.paths = response.paths;
                console.log(this.paths);
            }).catch((error) => {
                toast('Error obtaining attack paths.', false);
                console.error(error);
            })
        },

        getPathsV2() {
            current_report = $('#vulnerabilityReport').val();
            apiV2('POST', '/plugin/pathfinder/api', {'index':'paths_v2', 'id': current_report, 'source': this.selectedSource, 'target': this.selectedTarget}).then((response) => {
                toast('Returned possible attack paths.', true);
                console.log(response);
                this.paths = response.paths;
                this.path_success = response.path_success;
                this.path_stealth = response.path_stealth;
                this.path_persistance = response.path_persistance;
                this.path_speed = response.path_speed;
                console.log(this.paths);
                console.log(this.path_success);
                console.log(this.path_stealth);
                console.log(this.path_persistance);
                console.log(this.path_speed);
            }).catch((error) => {
                toast('Error obtaining attack paths.', false);
                console.error(error);
            })
        },

        createAdversaryV2(path) {
            current_report = $('#vulnerabilityReport').val();
            tags = $('#adversaryTags').val();
            console.log(this.selected_path);
            apiV2('POST', '/plugin/pathfinder/api', {'index':'create_adversary_v2', 'id': current_report, 'path': path, 'adversary_tags': tags}).then((response) => {
                removeOldPaths();
                addNewLinks(response.new_links);
                created_adversary = response.adversary_id;
                validateFormState(true, '#viewAdversaries');
                validateFormState(true, '#setupOperation');
                toast('Custom Pathfinder adversary created.', true);
            }).catch((error) => {
                toast('Error obtaining attack paths.', false);
                console.error(error);
            })
        },

        saveHost(host) {
            console.log(host);
            apiV2('POST', '/plugin/pathfinder/api', {'index':'update_host', 'host': host}).then((response) => {
                toast('Updated host object in report.', true);
            }).catch((error) => {
                toast('Error updating report.', false);
                console.error(error);
            })
        },
    };
}

//sourceURL=pathfinder.js
</script>
